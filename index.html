<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Interaktiv Aktörskarta</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }

    .filter-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      font-family: sans-serif;
    }
    .filter-container select {
      margin-bottom: 5px;
      width: 200px;
      padding: 3px;
    }

    .legend {
      background: white; 
      padding: 10px; 
      line-height: 1.5em;
      border-radius: 6px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      font-family: sans-serif;
    }
    .legend span {
      display: inline-block;
      width: 15px;
      height: 15px;
      margin-right: 5px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="filter-container">
    <label for="categorySelect"><b>Kategori:</b></label><br>
    <select id="categorySelect">
      <option value="alla">Alla</option>
      <option value="naringsliv">Näringsliv</option>
      <option value="offentlig">Offentlig sektor</option>
      <option value="utbildning">Universitet/forskning</option>
      <option value="finansiering">Gränsöverskridande samarbeten & finansiering</option>
      <option value="kultur">Kultur & sport</option>
    </select><br>

    <label for="regionSelect"><b>Region:</b></label><br>
    <select id="regionSelect">
      <option value="alla">Alla</option>
    </select><br>

    <label for="actorSelect"><b>Aktör:</b></label><br>
    <select id="actorSelect">
      <option value="alla">Alla</option>
    </select>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    var map = L.map('map').setView([63.0, 12.5], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var icons = {
      naringsliv: L.icon({iconUrl: 'https://img.icons8.com/color/48/000000/business.png', iconSize:[30,30]}),
      offentlig: L.icon({iconUrl: 'https://img.icons8.com/color/48/000000/government.png', iconSize:[30,30]}),
      utbildning: L.icon({iconUrl: 'https://img.icons8.com/color/48/000000/school.png', iconSize:[30,30]}),
      finansiering: L.icon({iconUrl: 'https://img.icons8.com/color/48/000000/money-bag.png', iconSize:[30,30]}),
      kultur: L.icon({iconUrl: 'https://img.icons8.com/color/48/000000/theatre-mask.png', iconSize:[30,30]})
    };

    var colors = {
      naringsliv: "red",
      offentlig: "blue",
      utbildning: "yellow",
      finansiering: "green",
      kultur: "orange"
    };

    var actors = [
      {name:"Företag A", category:"naringsliv", region:"Jämtland", coords:[63.17, 14.63], link:"https://example.com"},
      {name:"Kommun B", category:"offentlig", region:"Jämtland", coords:[63.43, 10.40], link:"https://example.com"},
      {name:"Universitet C", category:"utbildning", region:"Trøndelag", coords:[63.43, 10.40], link:"https://example.com"},
      {name:"Fond D", category:"finansiering", region:"Trøndelag", coords:[63.78, 11.30], link:"https://example.com"},
      {name:"Kultur E", category:"kultur", region:"Jämtland", coords:[62.47, 11.33], link:"https://example.com"}
    ];

    var markers = L.markerClusterGroup();
    var markerList = [];
    var densityCircles = L.layerGroup().addTo(map);

    function addMarkers(filterCategory, filterRegion, filterActor) {
      markers.clearLayers();
      densityCircles.clearLayers();
      markerList = [];
      var locationCount = {}; // för att räkna täthet

      actors.forEach(actor => {
        if ((filterCategory==="alla" || actor.category===filterCategory) &&
            (filterRegion==="alla" || actor.region===filterRegion) &&
            (filterActor==="alla" || actor.name===filterActor)) {

          var key = actor.coords.join(",");
          locationCount[key] = (locationCount[key] || 0) + 1;

          var marker = L.marker(actor.coords, {icon: icons[actor.category]});
          marker.bindPopup(`<b>${actor.name}</b><br>Kategori: ${actor.category}<br>Region: ${actor.region}<br><a href="${actor.link}" target="_blank">Webb</a>`);

          marker.on('mouseover', function() { this.openPopup(); });
          marker.on('mouseout', function() { this.closePopup(); });

          markers.addLayer(marker);
          markerList.push(marker);
        }
      });

      // Lägg till transparenta cirklar för täthet
      for (var loc in locationCount) {
        var parts = loc.split(",");
        var lat = parseFloat(parts[0]);
        var lng = parseFloat(parts[1]);
        var count = locationCount[loc];
        var radius = 200 * count; // storlek baserat på antal aktörer
        var circle = L.circle([lat,lng], {
          color: 'gray',
          fillColor: 'gray',
          fillOpacity: 0.2,
          radius: radius
        });
        densityCircles.addLayer(circle);
      }

      map.addLayer(markers);
    }

    addMarkers("alla","alla","alla");

    function updateDropdowns() {
      var category = document.getElementById("categorySelect").value;
      
      var regionSelect = document.getElementById("regionSelect");
      var regions = [...new Set(actors.filter(a=>category==="alla"||a.category===category).map(a=>a.region))];
      regionSelect.innerHTML = '<option value="alla">Alla</option>';
      regions.forEach(r => { regionSelect.innerHTML += `<option value="${r}">${r}</option>` });

      var actorSelect = document.getElementById("actorSelect");
      var filteredActors = actors.filter(a=>
        (category==="alla" || a.category===category) &&
        (regionSelect.value==="alla" || a.region===regionSelect.value));
      actorSelect.innerHTML = '<option value="alla">Alla</option>';
      filteredActors.forEach(a => { actorSelect.innerHTML += `<option value="${a.name}">${a.name}</option>` });
    }

    document.getElementById("categorySelect").addEventListener("change", function(){
      updateDropdowns();
      addMarkers(this.value,"alla","alla");
    });

    document.getElementById("regionSelect").addEventListener("change", function(){
      var category = document.getElementById("categorySelect").value;
      updateDropdowns();
      addMarkers(category,this.value,"alla");
    });

    document.getElementById("actorSelect").addEventListener("change", function(){
      var category = document.getElementById("categorySelect").value;
      var region = document.getElementById("regionSelect").value;
      addMarkers(category, region, this.value);
      if(this.value!=="alla"){
        var selectedMarker = markerList.find(m=>m.getPopup().getContent().includes(this.value));
        if(selectedMarker){
          map.setView(selectedMarker.getLatLng(), 10);
          selectedMarker.openPopup();
        }
      }
    });

    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function(map){
      var div = L.DomUtil.create('div','legend');
      div.innerHTML = "<h4>Kategorier</h4>";
      for(var key in colors){
        div.innerHTML += `<span style="background:${colors[key]}"></span>${key}<br>`;
      }
      return div;
    }
    legend.addTo(map);

  </script>
</body>
</html>
